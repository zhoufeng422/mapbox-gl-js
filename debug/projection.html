<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel='stylesheet' href='/dist/mapbox-gl.css' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #checkboxes {
            position: absolute;
            background: #fff;
            top: 0;
            left: 0;
            padding: 10px;
        }

        #buffer {
            position: absolute;
            top: 100px;
            left: 0;
            pointer-events: none;
        }

        #buffer div {
            background-color: #fff;
            padding: 5px 0;
            text-indent: 10px;
            white-space: nowrap;
            text-shadow:
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff;
        }
    </style>
</head>

<body>
    <div id='map'></div>
    <div id='checkboxes'>
        <input id='show-tile-boundaries-checkbox' name='show-tile-boundaries' type='checkbox'> <label
            for='show-tile-boundaries'>tile debug</label><br />
        <input id='show-symbol-collision-boxes-checkbox' name='show-symbol-collision-boxes' type='checkbox'> <label
            for='show-symbol-collision-boxes'>collision debug</label><br />
        <input id='show-overdraw-checkbox' name='show-overdraw' type='checkbox'> <label for='show-overdraw'>overdraw
            debug</label><br />
        <input id='buffer-checkbox' name='buffer' type='checkbox'> <label for='buffer'>buffer stats</label>
    </div>

    <div id='buffer' style="display:none">
        <em>Waiting for data...</em>
    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.14/proj4-src.js'></script>
    <script src='/dist/mapbox-gl-dev.js'></script>
    <script src='/debug/access_token_generated.js'></script>

    <script>
        var style = {
            "version": 8,
            "sources": {
                "prov_ploy": {
                    "type": "vector",
                    "url": "http://192.168.1.253:8081/data/re.json"
                }
            },
            "layers": [{
                "id": "background",
                "type": "background",
                "paint": {
                    "background-color": "rgb(4,7,14)"
                }
            }, {
                "id": "states",
                "type": "line",
                "source": "prov_ploy",
                "source-layer": "prov_ploy",
                "paint": {
                    "line-color": "#EC8D8D",
                    "line-width": {
                        "base": 1.5,
                        "stops": [
                            [
                                5,
                                0.75
                            ],
                            [
                                18,
                                32
                            ]
                        ]
                    }
                }
            }]
        };

        // Custom projection.  The dataset was generated by (a) projecting into albers
        // (using precisely the projection string being passed to `proj4` below, and then
        //  (b) piping into tippecanoe with -s EPSG:3785.
        // With this option set, tippecanoe does NOT try to project fron lnglat, but it
        // DOES do an affine transformation to go from EPSG's projected space (meters) to
        // tile space -- hence the small additional bits of math after `proj.forward` and
        // before `proj.inverse`.
        var name = '+proj=aea +lat_1=27 +lat_2=45 +lat_0=35 +lon_0=105 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs';
        var proj = proj4('WGS84', name);
        var C = 2 * Math.PI * 6378137.0;
        var projection = {
            latRange: undefined,
            isTransform: true,
            defName: name,

            XYFromLngLat(lng, lat) {
                let pt = proj.forward([lng, lat]);

                pt[0] = pt[0] / C + 0.5;
                pt[1] = 0.5 - pt[1] / C;

                return new mapboxgl.Point(pt[0], pt[1]);
            },
            LngLatFromXY(x, y) {
                const ll = proj.inverse([
                    C * (x - 0.5),
                    C * (0.5 - y)
                ]);
                
                return new mapboxgl.LngLat(ll[0], ll[1]);
            },
            project: function (lnglat, worldSize) {
                var pt = this.XYFromLngLat(lnglat.lng, lnglat.lat);
                var scale = (worldSize || this.worldSize);

                return new mapboxgl.Point(scale * pt.x, scale * pt.y);
            },
            unproject: function (point, worldSize) {
                var scale = (worldSize || this.worldSize);
                return this.LngLatFromXY(point.x / scale, point.y / scale);
            }
        };
        
        var map = window.map = new mapboxgl.Map({
            container: 'map',
            zoom: 3,
            center: [105.36, 32.85],
            style: 'http://192.168.1.253:8081/styles/nx_albers_dem/style.json',//,style
            // style: 'http://cagmss.com:81/styles/nx/style.json',
            projection: projection,
            hash: true
        });

        map.on('load', () => {
            map.addSource("overlay", {
                "type": "image",
                "url": "http://localhost:9966/debug/projection.png",
                "coordinates": [
                    // [79.3425659136, 52.85648743],
                    // [138.61433081, 52.85648743],
                    // [138.61433081, 13.9020680279],
                    // [79.3425659136, 13.9020680279]
                    // [63.2434347615, 50.6888687977],
                    // [139.358081995, 52.6812441072],
                    // [126.230984821, 15.0500346394],
                    // [78.871157332, 13.7652140709]
                    [48.2, 52.3],
                    [160.0, 53.0],
                    [135.8, 7.5],
                    [73.0, 7.0]
                    // [-2882702 - 55500, 2376777],
                    // [2312529 + 55500, 2376777],
                    // [2312529 + 55500, -1935070],
                    // [-2882702 - 55500, -1935070]
                ]
            });

            // map.addLayer({
            //     "id": "overlay",
            //     "source": "overlay",
            //     "type": "raster",
            //     "paint": { "raster-opacity": 0.85 }
            // });

            map.addLayer({
                "id": "points",
                "type": "symbol",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [104.5, 34.5]
                            },
                            "properties": {
                                "title": "Mapbox DC",
                                "icon": "monument"
                            }
                        }, {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [-122.414, 37.776]
                            },
                            "properties": {
                                "title": "Mapbox SF",
                                "icon": "harbor"
                            }
                        }]
                    }
                },
                "layout": {
                    // "icon-image": "{icon}-15",
                    "text-field": "{title}",
                    "text-font": [ "KlokanTech Noto Sans CJK Bold"],
                    "text-allow-overlap": true,
                    // "text-offset": [0, 0.6],
                    // "text-anchor": "top"
                }
            });
        
            const sId = "fjpoly";
            map.addSource(sId, {
                type: 'geojson',
                data: 'fj_city.json'
            });

            map.addLayer({
                'id': sId,
                'source': sId,
                'type': 'fill',
                'paint':{
                    'fill-color':'#1890ff'
                }
            });
        });

        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.GeolocateControl());

        map.on('click', function (e) {
            if (e.originalEvent.shiftKey) return;
            const feats = map.querySourceFeatures('fjpoly');
            console.log(feats);
            (new mapboxgl.Popup())
                .setLngLat(map.unproject(e.point))
                .setHTML("<h1>Hello World!</h1>" + JSON.stringify(e.point) + "<br />" + JSON.stringify(map.unproject(e.point)))
                .addTo(map);
        });

        document.getElementById('show-tile-boundaries-checkbox').onclick = function () {
            map.showTileBoundaries = !!this.checked;
        };

        document.getElementById('show-symbol-collision-boxes-checkbox').onclick = function () {
            map.showCollisionBoxes = !!this.checked;
        };

        document.getElementById('show-overdraw-checkbox').onclick = function () {
            map.showOverdrawInspector = !!this.checked;
        };

        document.getElementById('buffer-checkbox').onclick = function () {
            document.getElementById('buffer').style.display = this.checked ? 'block' : 'none';
        };

        // keyboard shortcut for comparing rendering with Mapbox GL native
        document.onkeypress = function (e) {
            if (e.charCode === 111 && !e.shiftKey && !e.metaKey && !e.altKey) {
                var center = map.getCenter();
                location.href = "mapboxgl://?center=" + center.lat + "," + center.lng + "&zoom=" + map.getZoom() + "&bearing=" + map.getBearing();
                return false;
            }
        };
    </script>

</body>

</html>